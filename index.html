<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBlnTXaiylzMn67Z4tKc46LwDLArlEBcnE",
    authDomain: "jbessential-def67.firebaseapp.com",
    projectId: "jbessential-def67",
    storageBucket: "jbessential-def67.appspot.com",
    messagingSenderId: "380875888035",
    appId: "1:380875888035:web:cf9b2e99b9a0b727533616",
    databaseURL: "https://jbessential-def67-default-rtdb.firebaseio.com"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const categories = [
    'All', 'Women Ethnic', 'Women Western', 'Men', 'Kids', 'Home & Kitchen',
    'Beauty & Health', 'Jewellery & Accessories', 'Bags & Footwear',
    'Electronics', 'Sports & Fitness', 'Car & Motorbike',
    'Office Supplies & Stationery', 'Pet Supplies', 'Musical Instruments', 'Books'
  ];

  let products = [];
  let cart = [];

  function buildCategoryBar() {
    const bar = document.getElementById('categoryBar');
    categories.forEach(cat => {
      const span = document.createElement('span');
      span.innerText = cat;
      span.onclick = () => filterByCategory(cat);
      bar.appendChild(span);
    });
  }

  function fetchProductsFromFirebase() {
    db.ref("products").once("value", snapshot => {
      const data = snapshot.val();
      products = [];
      for (let id in data) {
        products.push({
          id,
          name: data[id].name,
          price: data[id].price,
          desc: data[id].description,
          img: data[id].image,
          category: data[id].category
        });
      }
      filterByCategory("All"); // show all initially
    });
  }

  function filterByCategory(category) {
    const container = document.getElementById('product-list');
    container.innerHTML = '';

    const filtered = products.filter(p => category === 'All' || p.category === category);
    if (filtered.length === 0) {
      container.innerHTML = `<p class="text-muted">No products found in this category.</p>`;
      return;
    }

    filtered.forEach(p => {
      container.innerHTML += `<div class="col-md-3"><div class="product-card">
        <img src="${p.img}" class="img-fluid">
        <h5>${p.name}</h5>
        <p>${p.desc}</p>
        <p><strong>₹${p.price}</strong></p>
        <button class="btn btn-warning" onclick="addToCart('${p.id}')">Add to Cart</button>
      </div></div>`;
    });
  }

  function addToCart(id) {
    const existing = cart.find(i => i.id === id);
    if (existing) {
      existing.qty += 1;
    } else {
      const item = products.find(p => p.id === id);
      if (item) cart.push({ ...item, qty: 1 });
    }
    updateCartUI();
    localStorage.setItem("jb_cart", JSON.stringify(cart));
  }

  function updateCartUI() {
    document.getElementById('cart-count').innerText = cart.reduce((a, b) => a + b.qty, 0);
    let html = '', total = 0;
    cart.forEach((item, i) => {
      total += item.qty * item.price;
      html += `<li class="list-group-item d-flex justify-content-between align-items-center">
        ${item.name} x${item.qty} - ₹${item.qty * item.price}
        <button class="btn btn-sm btn-danger" onclick="removeCartItem(${i})">Remove</button>
      </li>`;
    });
    document.getElementById('cart-items').innerHTML = html;
    document.getElementById('cart-total').innerText = total;
  }

  function removeCartItem(i) {
    cart.splice(i, 1);
    updateCartUI();
    localStorage.setItem("jb_cart", JSON.stringify(cart));
  }

  function toggleCart() {
    const el = document.getElementById('cart-section');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
  }

  document.getElementById('miniTV').onclick = () => alert('Coming Soon: JB Mini TV');
  document.getElementById('foodDelivery').onclick = () => alert('Coming Soon: JB Food Delivery');

  window.onload = () => {
    cart = JSON.parse(localStorage.getItem("jb_cart")) || [];
    buildCategoryBar();
    fetchProductsFromFirebase(); // ✅ This fetches product from Firebase
    updateCartUI();
  };
</script>
